<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Travel Map</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=173e8e02cf7b67e1765534bd4da1a2ce&autoload=false&libraries=services,clusterer"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
        header { padding: 14px 18px; border-bottom: 1px solid #eee; display:flex; gap:12px; align-items:center; }
        header h1 { font-size: 18px; margin: 0 8px 0 0; }
        header .hint { color:#666; font-size: 13px; }
        .container { display: grid; grid-template-columns: 380px 1fr; height: calc(100vh - 60px); }
        .left { border-right: 1px solid #eee; padding: 12px; overflow: auto; }
        .left h2 { margin: 6px 0 10px; font-size: 16px; }
        .search-row { display:flex; gap:8px; }
        input[type="text"] { flex: 1; padding: 10px 12px; border:1px solid #ddd; border-radius:10px; }
        button { padding: 10px 14px; border:1px solid #ddd; background:#fafafa; border-radius:10px; cursor:pointer; }
        button.primary { background:white; border-color:#222; }
        .results { margin-top: 12px; display: grid; gap:8px; }
        .card { border:1px solid #eee; border-radius:12px; padding:10px; }
        .card h3 { margin: 0 0 6px; font-size: 15px; }
        .card p { margin: 2px 0; color:#555; font-size: 13px; }
        .pagination { display:flex; gap:6px; margin-top:8px; flex-wrap: wrap; }
        .pagination button { padding:6px 10px; border-radius: 8px; }
        .pill { display:inline-block; border:1px solid #eee; padding:4px 8px; border-radius:999px; font-size:12px; color:#666; }
        .map { position: relative; }
        #map { width: 100%; height: 100%; min-height: 420px; }
        .floating { position:absolute; top:10px; right:10px; background:white; border:1px solid #eee; border-radius:12px; padding:10px; display:flex; gap:8px; }
        .legend { position:absolute; bottom:10px; left:10px; background:white; border:1px solid #eee; border-radius:12px; padding:8px 10px; color:#555; font-size: 12px; }
        .muted { color:#777; font-size:12px; }
        .hr { height:1px; background:#f1f1f1; margin:8px 0; }
        .small { font-size: 12px; }
        .footer { padding:8px 12px; border-top:1px solid #eee; color:#666; font-size: 12px; }

        /* íƒ­ ê´€ë ¨ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .tabs { display:flex; justify-content: space-around; border-bottom: 1px solid #ddd; margin-top: 12px; }
        .tabs button { flex:1; border:none; background:none; cursor:pointer; padding: 10px 0; font-size:14px; color:#888; font-weight:500; border-bottom:2px solid transparent; transition: border-bottom 0.2s, color 0.2s; }
        .tabs button.active { color:#333; border-bottom:2px solid #555; font-weight:600; }
        #tabContent { padding-top: 12px; }
    </style>
</head>
<body>
<header>
    <h1>Travel Map</h1>
</header>
<div class="container">
    <aside class="left">
        <h2>100ëŒ€ ê´€ê´‘ì§€ ê²€ìƒ‰</h2>
        <div class="search-row">
            <input id="keyword" type="text" placeholder="ì˜ˆ) ê²½ë³µê¶, ì œì£¼ë„ ì¹´í˜, ìˆ˜ì› í™”ì„±" />
            <button class="primary" id="searchBtn">ê²€ìƒ‰</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
            <button id="nearbyBtn">ì£¼ë³€ ê´€ê´‘ì§€ ì°¾ê¸°</button>
            <span class="pill" id="centerCoords"></span>
        </div>
        <div class="hr"></div>
        <div class="tabs">
            <button class="tab-btn active" data-tab="results">100ëŒ€ ê´€ê´‘ì§€ ê²°ê³¼</button>
            <button class="tab-btn" data-tab="nearby">ì£¼ë³€ ê´€ê´‘ì§€</button>
        </div>
        <div id="tabContent">
            <div class="results" id="results"></div>
            <div class="pagination" id="pagination"></div>
            <div class="results" id="nearby" style="display: none;"></div>
        </div>
        <div class="hr"></div>
    </aside>
    <main class="map">
        <div id="map"></div>
    </main>
</div>
<script>
    // Kakao ë§µ ë¡œë”
    kakao.maps.load(function() {
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(37.8814, 127.7299), level: 6 };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        const clusterer = new kakao.maps.MarkerClusterer({ map: map, averageCenter: true, minLevel: 7 });
        const places = new kakao.maps.services.Places(); // Kakao Places API
        const infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
        const $results = document.getElementById('results');
        const $nearby = document.getElementById('nearby');
        const $centerCoords = document.getElementById('centerCoords');
        const $pagination = document.getElementById('pagination');
        const $keyword = document.getElementById('keyword');
        const $searchBtn = document.getElementById('searchBtn');
        const $nearbyBtn = document.getElementById('nearbyBtn');
        const $tabButtons = document.querySelectorAll('.tab-btn');
        const geocoder = new kakao.maps.services.Geocoder();

        let searchMarkers = []; // ë§ˆì»¤ ê°ì²´ ë°°ì—´
        let nearbyMarkers = []; // ì£¼ë³€ ê²€ìƒ‰ ë§ˆì»¤ ë°°ì—´

        function setCenterLabel() {
            const c = map.getCenter();
            $centerCoords.textContent = `center: ${c.getLat().toFixed(5)}, ${c.getLng().toFixed(5)}`;
        }
        setCenterLabel();
        kakao.maps.event.addListener(map, 'center_changed', setCenterLabel);

        // ë§ˆì»¤ ë° ëª©ë¡ ì´ˆê¸°í™”
        function clearAll() {
            try { clusterer.clear(); } catch (e) { console.warn('clusterer.clear ì˜¤ë¥˜:', e); }
            searchMarkers.forEach(m => m.setMap(null));
            nearbyMarkers.forEach(m => m.setMap(null));
            searchMarkers = [];
            nearbyMarkers = [];
            $results.innerHTML = '';
            $nearby.innerHTML = '';
            $pagination.innerHTML = '';
            infowindow.close();
        }

        // ì£¼ë³€ ë§ˆì»¤/ëª©ë¡ë§Œ í´ë¦¬ì–´ (ê²€ìƒ‰ ê²°ê³¼ ìœ ì§€)
        function clearNearbyOnly() {
            try {
                // clustererì—ì„œ ê¸°ì¡´ nearby ë§ˆì»¤ë¥¼ ì œê±°í•˜ë ¤ë©´ ì „ì²´ clear í›„ ê²€ìƒ‰ë§ˆì»¤ ì¬ë“±ë¡
                // ê°„ë‹¨í•œ ë°©ë²•: clear clusterer, ì¬ë“±ë¡ searchMarkers (ì¡´ì¬í•˜ë©´)
                try { clusterer.clear(); } catch (e) {}
                if (searchMarkers.length) clusterer.addMarkers(searchMarkers);
            } catch (e) { console.warn('clearNearbyOnly clusterer ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', e); }

            nearbyMarkers.forEach(m => m.setMap(null));
            nearbyMarkers = [];
            $nearby.innerHTML = '';
        }

        // DB ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderDBList($el, items) {
            $el.innerHTML = '';
            items.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${idx + 1}. ${p.title || p.place_name || ''}</h3>
                    <p>${p.address || p.road_address_name || p.address_name || ''}</p>
                    <p class="small muted">ì „í™”: ${p.phone || '-'}</p>
                `;
                // í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ (ì£¼ì†Œ -> ì¢Œí‘œ)
                card.onclick = () => {
                    if (p.y && p.x) {
                        const coords = new kakao.maps.LatLng(parseFloat(p.y), parseFloat(p.x));
                        map.panTo(coords);
                    } else if (p.address && p.address.trim() !== '') {
                        geocoder.addressSearch(p.address, function(result, status) {
                            if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                map.panTo(coords);
                            } else {
                                alert('ì£¼ì†Œì—ì„œ ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                console.error('ì£¼ì†Œ->ì¢Œí‘œ ì‹¤íŒ¨:', p.address, status);
                            }
                        });
                    } else {
                        alert('ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }
                };
                $el.appendChild(card);
            });
        }

        // ì¹´ì¹´ì˜¤ API ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderKakaoList($el, items) {
            $el.innerHTML = '';
            items.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${idx + 1}. ${p.place_name}</h3>
                    <p>${p.road_address_name || p.address_name || ''}</p>
                    <p class="small muted">ì „í™”: ${p.phone || '-'}</p>
                `;
                // í´ë¦­í•˜ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™
                card.onclick = () => {
                    const pos = new kakao.maps.LatLng(p.y, p.x);
                    map.panTo(pos);
                };
                $el.appendChild(card);
            });
        }

        // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function addMarkers(locations, colorEmoji) {
            const bounds = new kakao.maps.LatLngBounds();
            const newMarkers = [];

            locations.forEach((p, i) => {
                const lat = parseFloat(p.y);
                const lng = parseFloat(p.x);
                if (Number.isNaN(lat) || Number.isNaN(lng)) return;
                const pos = new kakao.maps.LatLng(lat, lng);
                bounds.extend(pos);

                const number = (i % 99) + 1;
                const numberColor = colorEmoji === 'ğŸ”µ' ? 'blue' : 'green';
                const markerImage = new kakao.maps.MarkerImage(
                    `https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_number_${numberColor}.png`,
                    new kakao.maps.Size(36, 37),
                    { spriteSize: new kakao.maps.Size(36, 691), spriteOrigin: new kakao.maps.Point(0, (i * 46) + 10) }
                );

                const marker = new kakao.maps.Marker({ position: pos, image: markerImage });
                newMarkers.push(marker);

                kakao.maps.event.addListener(marker, 'click', function() {
                    const html = `
                    <div style="padding:8px 10px">
                        <div style="font-weight:600;margin-bottom:4px">${p.title || p.place_name || ''}</div>
                        <div style="font-size:12px;color:#555">${p.address || p.road_address_name || p.address_name || ''}</div>
                        <div style="font-size:12px;color:#666">ì „í™”: ${p.phone || '-'}</div>
                    </div>`;
                    infowindow.setContent(html);
                    infowindow.open(map, marker);
                });
            });

            if (newMarkers.length > 0) {
                clusterer.addMarkers(newMarkers);
                try {
                    if (!bounds.isEmpty()) map.setBounds(bounds);
                } catch (e) { console.warn('setBounds ì˜¤ë¥˜:', e); }
            }
            return newMarkers;
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
        function renderPagination(pagination) {
            $pagination.innerHTML = '';
            if (!pagination || pagination.totalPages <= 1) {
                return;
            }

            for (let i = 1; i <= pagination.totalPages; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;

                if (i === pagination.page) btn.disabled = true;

                btn.addEventListener('click', (() => {
                    const pageNum = i;
                    return () => searchKeyword(pageNum);
                })());
                $pagination.appendChild(btn);
            }
        }

        // ê²€ìƒ‰ (ì„œë²„ ìš°ì„ , ì„œë²„ì— ì—†ì„ ë•ŒëŠ” ê²°ê³¼íƒ­ì— ê³ ì • ë©”ì‹œì§€ í‘œì‹œ)
        function searchKeyword(page = 1, size = 10) {
            clearAll();
            const kw = $keyword.value.trim();
            if (!kw) {
                alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // ì„œë²„ì—ì„œ ë¨¼ì € ì‹œë„
            fetch(`/yerinTravel/search?keyword=${encodeURIComponent(kw)}&page=${page}&size=${size}`)
                .then(response => {
                    if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ' + response.status);
                    return response.json();
                })
                .then(res => {
                    const { items, pagination } = res || {};
                    if (Array.isArray(items) && items.length > 0) {
                        activateTab('results');
                        const geocodingPromises = items.map(p => {
                            return new Promise(resolve => {
                                if (!p.address || p.address.trim() === '') {
                                    if (p.y && p.x) resolve({ ...p, y: p.y, x: p.x });
                                    else resolve(null);
                                    return;
                                }
                                geocoder.addressSearch(p.address, function(result, status) {
                                    if (status === kakao.maps.services.Status.OK && result.length > 0) {
                                        resolve({ ...p, y: result[0].y, x: result[0].x });
                                    } else {
                                        console.warn('geocode ì‹¤íŒ¨:', p.address, status);
                                        resolve(null);
                                    }
                                });
                            });
                        });

                        Promise.all(geocodingPromises)
                            .then(geocodedData => {
                                const validData = geocodedData.filter(d => d !== null);
                                if (validData.length > 0) {
                                    searchMarkers = addMarkers(validData, 'ğŸ”µ');
                                    renderDBList($results, validData);
                                    map.panTo(new kakao.maps.LatLng(validData[0].y, validData[0].x));
                                } else {
                                    // ì„œë²„ ì‘ë‹µì€ ìˆì—ˆì§€ë§Œ ì£¼ì†Œ ë³€í™˜ì´ ì „ë¶€ ì‹¤íŒ¨í•œ ê²½ìš° â€” ë©”ì‹œì§€ í‘œì‹œ
                                    showNoDbResultsMessage(kw);
                                }
                            })
                            .catch(err => {
                                console.error('geocoding ì¤‘ ì˜¤ë¥˜:', err);
                                showNoDbResultsMessage(kw);
                            });

                        renderPagination(pagination || { totalPages: 1, page: 1 });
                        return;
                    }

                    // ì„œë²„ëŠ” ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí–ˆìœ¼ë‚˜ í•­ëª©ì´ ì—†ìŒ -> ê²°ê³¼íƒ­ì— ê³ ì • ë©”ì‹œì§€ í‘œì‹œ
                    showNoDbResultsMessage(kw);
                })
                .catch(error => {
                    console.error('ì„œë²„ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                    // ì„œë²„ í˜¸ì¶œ ì‹¤íŒ¨ ì‹œì—ë„ ê²°ê³¼íƒ­ì— ê³ ì • ë©”ì‹œì§€ í‘œì‹œ (ìš”ì²­ì— ë”°ë¼ ì¹´ì¹´ì˜¤ í´ë°±ì€ í•˜ì§€ ì•ŠìŒ)
                    showNoDbResultsMessage(kw);
                });
        }

        // '100ëŒ€ ê´€ê´‘ì§€ì— í¬í•¨ë˜ëŠ” ê³³ì´ ì—†ìŠµë‹ˆë‹¤' ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showNoDbResultsMessage(kw) {
            activateTab('results');
            $results.innerHTML = '';
            const msgCard = document.createElement('div');
            msgCard.className = 'card';
            msgCard.innerHTML = `<h3>100ëŒ€ ê´€ê´‘ì§€ì— í¬í•¨ë˜ëŠ” ê³³ì´ ì—†ìŠµë‹ˆë‹¤</h3>`;
            $results.appendChild(msgCard);
            $pagination.innerHTML = '';

            // ì§€ë„ ì´ë™: ì£¼ì†Œê°€ ìˆìœ¼ë©´ ì¤‘ì‹¬ ì´ë™
            if (kw && kw.trim() !== '') {
                geocoder.addressSearch(kw, function(result, status) {
                    if (status === kakao.maps.services.Status.OK && result.length > 0) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        map.panTo(coords);
                    } else {
                        console.warn('ì£¼ì†Œ->ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨:', kw, status);
                    }
                });
            }
        }


        // ì£¼ë³€ ê´€ê´‘ì§€ (ì¹´ì¹´ì˜¤ APIì—ì„œ í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ê²€ìƒ‰)
        // ë³€ê²½ì : clearAll ì œê±°, nearbyë§Œ ì´ˆê¸°í™” í›„ ê²€ìƒ‰ ìˆ˜í–‰, íƒ­ í™œì„±í™” ìƒíƒœì— ë”°ë¼ í´ëŸ¬ìŠ¤í„°ëŸ¬ì— í‘œì‹œ
        function searchNearbyAttractions() {
            // don't call clearAll() here to avoid losing searchMarkers
            clearNearbyOnly(); // clear previous nearby-only markers/list

            const center = map.getCenter();

            places.categorySearch('AT4', function(data, status) {
                if (status !== kakao.maps.services.Status.OK) {
                    console.warn('ì£¼ë³€ ê´€ê´‘ì§€ ê²€ìƒ‰ ì‹¤íŒ¨:', status);
                    alert('ì£¼ë³€ ê´€ê´‘ëª…ì†Œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                // ëª©ë¡ ë Œë”
                renderKakaoList($nearby, data);

                const markers = [];
                const bounds = new kakao.maps.LatLngBounds();

                data.forEach(p => {
                    const pos = new kakao.maps.LatLng(p.y, p.x);
                    bounds.extend(pos);
                    const marker = new kakao.maps.Marker({
                        position: pos,
                        image: new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35))
                    });
                    markers.push(marker);

                    kakao.maps.event.addListener(marker, 'click', function() {
                        const html = `<div style="padding:8px 10px"><div style="font-weight:600;margin-bottom:4px">[ê´€ê´‘ëª…ì†Œ] ${p.place_name}</div>
                                        <div style="font-size:12px;color:#555">${p.road_address_name || p.address_name || ''}</div>
                                        <a href="${p.place_url}" target="_blank" style="font-size:12px">ìƒì„¸ë³´ê¸°</a></div>`;
                        infowindow.setContent(html);
                        infowindow.open(map, marker);
                    });
                });

                nearbyMarkers = markers;

                // í˜„ì¬ í™œì„± íƒ­ì´ nearbyì´ë©´ ë°”ë¡œ í‘œì‹œ (í´ëŸ¬ìŠ¤í„°/ì§€ë„ ë°”ìš´ë“œ)
                const nearbyTabBtn = document.querySelector('.tab-btn[data-tab="nearby"]');
                const isNearbyActive = nearbyTabBtn && nearbyTabBtn.classList.contains('active');

                if (isNearbyActive) {
                    try { clusterer.clear(); } catch (e) {}
                    if (nearbyMarkers.length) clusterer.addMarkers(nearbyMarkers);
                    try { if (!bounds.isEmpty()) map.setBounds(bounds); } catch (e) { console.warn('bounds ì„¤ì • ì‹¤íŒ¨:', e); }
                }
            }, { location: center, radius: 5000 });
        }

        // íƒ­ í™œì„±í™” í•¨ìˆ˜
        function activateTab(tabName) {
            $tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });
            // ê²°ê³¼ íƒ­ê³¼ ì£¼ë³€ íƒ­ í† ê¸€
            if (tabName === 'results') {
                $results.style.display = 'grid';
                $nearby.style.display = 'none';
                try { clusterer.clear(); } catch (e) {}
                if (searchMarkers.length) clusterer.addMarkers(searchMarkers);
            } else if (tabName === 'nearby') {
                $results.style.display = 'none';
                $nearby.style.display = 'grid';
                try { clusterer.clear(); } catch (e) {}
                if (nearbyMarkers.length) clusterer.addMarkers(nearbyMarkers);
            }
        }

        // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ ê²€ìƒ‰ ê²°ê³¼ íƒ­ì´ í™œì„±í™”ë˜ë„ë¡ ì„¤ì •
        activateTab('results');

        // ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì•ˆì „í•˜ê²Œ ë˜í•‘)
        $searchBtn.addEventListener('click', () => searchKeyword());
        $nearbyBtn.addEventListener('click', () => searchNearbyAttractions());
        document.getElementById('keyword').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchKeyword();
        });
        $tabButtons.forEach(btn => btn.addEventListener('click', () => {
            const tabName = btn.getAttribute('data-tab');
            // íƒ­ í´ë¦­ ì‹œ: ê²°ê³¼ íƒ­ì´ë©´ ë°”ë¡œ í™œì„±í™”, ì£¼ë³€ íƒ­ì´ë©´ í™œì„±í™” í›„ nearbyMarkersê°€ ë¹„ì–´ìˆë‹¤ë©´ ìë™ ê²€ìƒ‰
            if (tabName === 'nearby') {
                activateTab('nearby');
                if (!nearbyMarkers || nearbyMarkers.length === 0) {
                    searchNearbyAttractions();
                }
            } else {
                activateTab(tabName);
            }
        }));
    });
</script>
</body>
</html>
