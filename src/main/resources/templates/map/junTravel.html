<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Travel Information</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f28820e3c722b9045e555e9e1457b6ca&libraries=services"></script>
    <style>
        * { box-sizing: border-box; }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        body { margin: 0; font-family: Pretendard, sans-serif; }

        header {
            position: absolute;   /* 지도 위에 고정 */
            top: 10px;
            left: 10px;
            z-index: 1000;        /* 지도 위에 보이게 */
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);

            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-main {
            display: inline-block;
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border-radius: 4px;
            text-decoration: none;
        }
        .btn-main:hover {
            background: #0056b3;
        }


        #container { display: flex; height:100vh; }

        #sidebar {
            width: 280px;
            border-right: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background: #f5f5f5;
        }

        #results { display: flex; flex-direction: column; gap: 8px; margin-top: 70px; }

        .result-item {
            display: flex; flex-direction: column;
            border: 2px solid #ccc; border-radius: 6px;
            overflow: hidden; cursor: pointer;
            background: #fff;
        }
        .result-title { padding: 8px; font-weight: bold; font-size: 15px; background: #73eafe; }
        .kakao-result-title { padding: 8px; font-weight: bold; font-size: 15px; background: #f9f871; }
        .result-address { padding: 8px; font-size: 14px; background: #ffffff; }

        #map { flex: 1; }

        .search-box { width: 70%; padding: 6px; font-size: 16px; }
        button { padding: 6px 10px; }
        .pager { display:flex; justify-content:center; gap:6px; margin:10px 0 4px; flex-wrap: wrap; }
        .pager a.active { font-weight: bold; color: red; }
    </style>
</head>
<body>
<header>
    <a href="/" class="btn-main">메인으로</a>
    <form th:action="@{/junTravel/list}" method="get">
        <input type="text" name="keyword" class="search-box" placeholder="지역 검색" th:value="${keyword}">
        <button type="submit">검색</button>
    </form>
</header>

<div id="container">
    <div id="sidebar">

        <div id="results">
            <!-- DB 결과 -->
            <div th:each="t : ${travels}" class="result-item"
                 th:attr="data-title=${t.title}, data-address=${t.address}">
                <div class="result-title" th:text="${t.title}">제목</div>
                <div class="result-address" th:text="${t.address}">주소</div>
            </div>
        </div>

        <!-- 페이지네이션 -->
        <div class="pager" th:if="${pagination != null}">
            <!-- DB 페이지 버튼 -->
            <a th:if="${pagination.page > 1}"
               th:href="@{/junTravel/list(page=${pagination.page-1}, size=${pagination.size}, keyword=${keyword})}">이전</a>

            <a th:each="p : ${#numbers.sequence(pagination.startPage, pagination.endPage)}"
               th:href="@{/junTravel/list(page=${p}, size=${pagination.size}, keyword=${keyword})}"
               th:text="${p}"
               th:classappend="${p == pagination.page} ? 'active'"></a>

            <a th:if="${pagination.page < pagination.totalPages}"
               th:href="@{/junTravel/list(page=${pagination.page+1}, size=${pagination.size}, keyword=${keyword})}">다음</a>

            <!-- ✅ 카카오 결과 페이지 버튼 (DB totalPages + 1 ~ totalPages + 3) -->
            <span th:if="${pagination.page == pagination.totalPages}">
                <a href="#" onclick="renderKakaoPage(1)" id="kakaoPage1">[[${pagination.totalPages + 1}]]</a>
                <a href="#" onclick="renderKakaoPage(2)" id="kakaoPage2">[[${pagination.totalPages + 2}]]</a>
                <a href="#" onclick="renderKakaoPage(3)" id="kakaoPage3">[[${pagination.totalPages + 3}]]</a>
            </span>
        </div>
    </div>

    <div id="map"></div>
</div>

<script>
    let map, geocoder, ps;
    let markers = [];
    let currentOverlay = null;
    let kakaoResults = []; // 카카오 전체 검색 결과 저장
    let currentKeyword = "";

    const blueMarkerImg = new kakao.maps.MarkerImage(
        "http://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png",
        new kakao.maps.Size(24, 35)
    );
    const yellowMarkerImg = new kakao.maps.MarkerImage(
        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
        new kakao.maps.Size(24, 35)
    );

    function closeCurrentOverlay() {
        if (currentOverlay) {
            currentOverlay.setMap(null);
            currentOverlay = null;
        }
    }

    function clearMarkers() {
        markers.forEach(m => m.setMap(null));
        markers = [];
    }

    function buildOverlayContent(title, address) {
        return `
          <div style="border:1px solid #ccc;border-radius:6px;width:260px;overflow:hidden;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.2);">
            <div style="font-weight:bold;font-size:15px;padding:8px;background:#bafe96;">${title}</div>
            <div style="padding:8px;font-size:13px;color:#333;">${address}</div>
          </div>
        `;
    }

    function initMap() {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(37.566535, 126.977969), level: 5 };
        map = new kakao.maps.Map(container, options);

        geocoder = new kakao.maps.services.Geocoder();
        ps = new kakao.maps.services.Places();

        // DB travels 마커 찍기
        document.querySelectorAll(".result-item").forEach(div => {
            const title = div.dataset.title;
            const address = div.dataset.address;

            geocoder.addressSearch(address, function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0]) {
                    const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                    const marker = new kakao.maps.Marker({
                        map,
                        position: coords,
                        image: blueMarkerImg // DB → 파란색
                    });
                    markers.push(marker);

                    const overlay = new kakao.maps.CustomOverlay({
                        content: buildOverlayContent(title, address),
                        position: coords,
                        yAnchor: 1
                    });

                    kakao.maps.event.addListener(marker, 'click', () => {
                        closeCurrentOverlay();
                        overlay.setMap(map);
                        currentOverlay = overlay;
                    });

                    div.onclick = () => {
                        map.setCenter(coords);
                        map.setLevel(4);
                        closeCurrentOverlay();
                        overlay.setMap(map);
                        currentOverlay = overlay;
                    };
                }
            });
        });
        setTimeout(moveMapToFirstResult, 800);
        // ✅ keyword 값 보관
        const keywordInput = document.querySelector("input[name='keyword']");
        if (keywordInput && keywordInput.value) {
            currentKeyword = keywordInput.value;
            loadKakaoResults(currentKeyword);
        }

    }
    function moveMapToFirstResult() {
        const firstAddressEl = document.querySelector(".result-address");

        if (firstAddressEl) {
            // DB 결과가 존재하면 DB 주소로 이동
            const address = firstAddressEl.textContent.trim();
            if (address) {
                geocoder.addressSearch(address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK && result[0]) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        map.setCenter(coords);
                        map.setLevel(4);
                    }
                });
                return;
            }
        }

        // DB 결과 없으면 카카오 결과로 이동
        if (kakaoResults.length > 0) {
            const first = kakaoResults[0];
            const coords = new kakao.maps.LatLng(first.y, first.x);
            map.setCenter(coords);
            map.setLevel(4);
        }
    }

    // 카카오 전체 결과 미리 불러오기 (최대 24개: 8개 x 3페이지)
    function loadKakaoResults(keyword) {
        kakaoResults = [];
        function fetchPage(p) {
            ps.keywordSearch(keyword, (data, status, pagination) => {
                if (status === kakao.maps.services.Status.OK) {
                    kakaoResults = kakaoResults.concat(data);
                    if (p < 3 && !pagination.isEnd) { // 최대 3페이지
                        fetchPage(p + 1);
                    }
                }
            }, {page: p, size: 8});
        }
        fetchPage(1);
    }

    // 카카오 페이지 렌더링
    function renderKakaoPage(kakaoPage) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.innerHTML = ""; // 초기화
        clearMarkers();

        const start = (kakaoPage - 1) * 8;
        const end = start + 8;
        const slice = kakaoResults.slice(start, end);

        slice.forEach((place, idx) => {
            const coords = new kakao.maps.LatLng(place.y, place.x);
            const marker = new kakao.maps.Marker({
                map,
                position: coords,
                image: yellowMarkerImg // 카카오 → 노란색
            });
            markers.push(marker);

            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `
                <div class="kakao-result-title">${place.place_name}</div>
                <div class="result-address">${place.address_name}</div>
            `;

            const overlay = new kakao.maps.CustomOverlay({
                content: buildOverlayContent(place.place_name, place.address_name),
                position: coords,
                yAnchor: 1
            });

            kakao.maps.event.addListener(marker, 'click', () => {
                closeCurrentOverlay();
                overlay.setMap(map);
                currentOverlay = overlay;
            });

            div.onclick = () => {
                map.setCenter(coords);
                map.setLevel(4);
                closeCurrentOverlay();
                overlay.setMap(map);
                currentOverlay = overlay;
            };

            resultsDiv.appendChild(div);
        });

        if (slice.length > 0) {
            map.setCenter(new kakao.maps.LatLng(slice[0].y, slice[0].x));
            map.setLevel(4);
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
